《语控未来城 (SmartCity)》智慧城市数字孪生系统综合需求文档 (PRD)

1. 项目概述
   1.1 项目背景
   传统数字孪生系统交互逻辑僵化。本项目通过 智谱 AI (GLM-4) 赋予系统语义理解能力，并允许用户根据应用场景（如应急、规划、展示）自定义 AI 的“大脑”配置，实现从“固定看板”到“个性化城市大脑”的跨越。
   1.2 核心目标
   语义驱动控制：通过自然语言操控 Cesium.js 实现 3D 场景联动。
   AI 深度自定义：用户可自主选择模型版本、角色预设及执行策略。
   态势感知感知：接入高德/和风天气等实时数据，实现动态孪生。
   智能决策支持结合空间分析：基于 MySQL 资产数据进行灾害模拟与逻辑推理。
2. 技术架构方案
   前端 (View)：React 18 + Cesium.js + Ant Design (UI) + Tailwind CSS。
   后端 (Brain)：Python 3.9+ (FastAPI) + SQLAlchemy (ORM)。
   AI 适配层 (AI Layer)：智谱 AI (GLM-4)，支持动态参数配置与 Function Calling。
   数据库 (Storage)：MySQL 8.0 (存储资产数据、用户个性化配置、操作日志)。
   数据源：OSM (建筑)、DataV.GeoAtlas (地理边界)、高德/和风 (实时数据)。
3. 功能需求模块
   3.1 3D 数字孪生渲染模块 (Cesium.js)
   基础加载：支持卫星底图、全球地形及 3D Tiles 城市白模加载。
   动态视觉特效：
   环境同步：根据 AI 调用的实时天气数据，切换雨、雪、雾、昼夜光影。
   重绘渲染：支持建筑材质动态变色（高亮、红闪预警）、流光路径（路况）。
   镜头操控：支持平滑飞行 (FlyTo)、环绕飞行、第一人称视角切换。
   3.2 AI 语义配置与交互模块 (核心融合项)
   AI 自主选择中心 (User Choice)：
   模型切换：用户可在前端选择 GLM-4-Flash（追求极速响应）或 GLM-4-Plus/Air（追求深度逻辑推理）。
   自定义 API Key：支持用户填入私有智谱 Key，保障数据额度独立。
   参数微调：支持调节 Temperature（创造力）和 Top_p。
   角色预设 (Persona)：
   管理员模式：回复简练，侧重执行视角切换、报警响应。
   规划师模式：侧重数据分析，会主动调用查询接口提供选址分析报告。
   极客模式：显示 AI 解析出的完整 JSON 指令流。
   执行策略自定义：
   自动执行：AI 解析指令后地图立即响应。
   审核执行：AI 弹出指令确认框（如“是否确认飞往外滩？”），用户点击后执行。
   3.3 数据服务与分析模块 (Python + MySQL)
   资产检索：从 MySQL 中通过高度、类型、风险等级筛选建筑。
   空间模拟：
   圆心模拟：用户设定圆心与半径，AI 筛选受影响资产并改变 3D 颜色。
   趋势预测：结合历史态势数据与 AI 推理，生成城市运行简报。
4. 数据库设计 (MySQL)
   4.1 建筑资产表 (tb_buildings)
   字段名 类型 说明
   id String (PK) 唯一 ID
   name VARCHAR 建筑名称
   category VARCHAR 类型 (办公/地标/住宅)
   height FLOAT 建筑高度
   lng_lat POINT 经纬度空间坐标
   status String 0:正常, 1:异常, 2:高风险
   4.2 用户个性化配置表 (tb_user_config)
   字段名 类型 说明
   user_id String (PK) 用户唯一标识
   model_name VARCHAR 当前选用的模型版本 (如 glm-4-flash)
   api_key VARCHAR 用户自定义 Key (加密存储)
   persona VARCHAR 角色设定 (admin/planner/geek)
   temperature FLOAT 随机性参数 (0-1)
   auto_execute BOOLEAN 是否开启自动指令执行
5. 核心交互流程（含配置校验）
   用户配置：用户在 React UI 设置面板将模型设为 GLM-4-Plus，角色设为 规划师，开启 审核执行。
   自然语言输入：“分析一下静安区高度超过 150 米建筑的消防覆盖情况。”
   后端处理：
   FastAPI 提取用户配置，带上“规划师”专属 System Prompt 请求智谱 API。
   AI 解析意图，触发 SEARCH_BUILDINGS 与 ANALYSIS_FIRE_COVERAGE 指令。
   指令审核：前端弹出卡片：“AI 建议：高亮静安区 12 处重点建筑并分析，是否执行？”
   前端执行：用户点击确认，Cesium 视角飞行并渲染建筑热力颜色，侧边栏展示 AI 生成的分析报告。
6. 关键 Prompt 设计（动态生成策略）
   后端将根据用户选择的 Persona 动态拼接 Prompt：
   Base Prompt: "你是一个智慧城市控制大脑，必须输出 JSON 格式指令。"
   If Admin: "你的风格是果断、高效。只执行操作，不进行多余解释。"
   If Planner: "你的风格是严谨、详尽。在执行操作前，必须查询 MySQL 数据并给出空间分析建议。"
   Tool List: 定义 FLY_TO, SET_COLOR, QUERY_ASSETS, WEATHER_SYNC 等函数。
7. 非功能性需求
   响应延迟：使用 GLM-4-Flash 时，端到端指令解析时间应 < 1.5s。
   渲染稳定性：Cesium 场景在加载 3D Tiles 时需保持帧率 > 30FPS。
   安全性：用户自定义 API Key 必须进行 AES 对称加密存储。
8. 实施路线图
   W1-W2 (基础渲染)：React 集成 Cesium，实现 3D 白模加载，MySQL 导入建筑 POI。
   W3 (配置中心)：开发前端设置面板，后端实现基于用户配置动态初始化智谱客户端。
   W4 (语义闭环)：实现核心 Function Calling 逻辑，完成从“对话选择模型”到“地图动作”的连通。
   W5 (态势联动)：接入高德/天气数据，实现 AI 驱动的天气/路况图层切换。
   W6 (优化沉淀)：编写“场景模式”预设，优化 3D Shader 特效（如洪水积水、建筑流光）。
   给开发者的核心建议：
   坐标系统一：高德 API 数据（GCJ-02）传给 Cesium（WGS-84）前，一定要在 Python 后端做纠偏转换。
   Token 节省：在“规划师模式”下，不要把整个数据库塞给 AI，只在 Function Calling 返回结果中包含关键的建筑 ID 和摘要。
   异步处理：AI 解析和 3D 加载建议使用异步机制，避免前端 UI 阻塞。
